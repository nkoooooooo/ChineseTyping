<!DOCTYPE html>
<html lang="zh-HK">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>練習頁面</title>
  <!-- 引入Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .sticky-top {
      z-index: 1020;
    }

    .text-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: start;
      border: 1px solid #ddd;
      overflow-y: auto;
      height: 250px;
      width: 100%;
      max-width: 80%;
      margin: 20px auto;
    }

    .character {
      text-align: center;
      margin: 10px;
    }

    .character span {
      font-size: 24px;
    }

    .character sub {
      display: block;
      color: #888;
      margin-top: 5px;
    }

    .page-container {
      position: relative;
      min-height: calc(100vh - 80px - 40px);
      /* 根据导航栏和footer的实际高度调整 */
    }

    footer {
      width: 100%;
      text-align: center;
      padding: 10px 0;
      font-size: 0.9em;
      background: #f1f1f1;
      color: #888;
    }

    #google-form {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80%;
      /* Or any other width you want */
      margin: 20px auto;
    }

    #inputField {
      margin: 10px 0;
      padding: 10px;
      height: 30vh;
    }

    .response-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80%;
      /* Or any other width you want */
      margin: 20px auto;
    }

    #responseText {
      display: flex;
      flex-wrap: wrap;
      justify-content: start;
      border: 1px solid #ddd;
      overflow-y: auto;
      height: 250px;
      padding: 10px;
    }

    .correct {
      color: green;
      font-weight: bold;
    }

    .incorrect {
      color: red;
      font-weight: bold;
    }

    #inputButtons {
      margin-top: 10px;
      /* 在输入区和按钮区之间添加一些空间 */
    }

    .input-symbol {
      background-color: #f5f5f5;
      /* 按钮背景颜色 */
      border: 1px solid #ddd;
      /* 边框颜色和宽度 */
      border-radius: 5px;
      /* 圆角按钮 */
      margin-right: 8px;
      /* 按钮之间的右边距 */
      padding: 5px 10px;
      /* 上下和左右的内填充 */
      font-size: 16px;
      /* 文本大小 */
      cursor: pointer;
      /* 鼠标悬停时的指针形状 */
      transition: background-color 0.3s, transform 0.1s;
      /* 背景颜色和按下效果的过渡 */
    }

    /* 鼠标悬停时按钮的样式 */
    .input-symbol:hover {
      background-color: #eaeaea;
      /* 悬停时的背景颜色 */
    }

    /* 按钮被按下时的样式 */
    .input-symbol:active {
      transform: translateY(2px);
      /* 按钮按下后下移2px */
    }

    .word-count-container {
      margin-left: auto;
      margin-right: 0;
    }
  </style>
</head>

<body>
  <!-- Sticky Navbar 上方的导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">中文打字平台</a>
      <span class="navbar-text ms-auto" id="username">用戶名稱</span>
      <button class="btn btn-outline-warning ms-3" onclick="logout()">登出</button>
    </div>
  </nav>

  <div class="page-container">
    <div class="text-container" id="exerciseText"></div>
    <!-- 打字練習的地方，表單提交到Google表單 -->
    <form id="google-form"
      action="https://docs.google.com/forms/d/e/1FAIpQLScamnBpVLSJ1TXQOX2IhNu8XNUwKj8O8MdAUowCjmWl3eDiQQ/formResponse"
      method="post" target="_blank">

      <!-- 輸入學生電郵的輸入框 -->
      <input type="text" name="entry.642787572" id="email" hidden>
      <!-- 輸入學生姓名的輸入框 -->
      <input type="text" name="entry.101423020" id="gname" hidden>
      <!-- 輸入題號的輸入框 -->
      <input type="text" name="entry.2023010530" id="qno" hidden>
      <!-- 輸入題目名稱的輸入框 -->
      <input type="text" name="entry.505150958" id="qname" hidden>
      <!-- 輸入正確字數的輸入框 -->
      <input type="text" name="entry.1482062752" id="qcorrectnum" hidden>
      <!-- 輸入錯誤字數的輸入框 -->
      <input type="text" name="entry.1603506777" id="qincorrectnum" hidden>
      <!-- 輸入進度的輸入框 -->
      <input type="text" name="entry.215344342" id="qprogress" hidden>
      <!-- 這裡的name屬性需要對應到Google表單中的input name -->
      <label for="entry.1329760247">請在下方輸入您的文字：</label>
      <div id="inputButtons">
        <button type="button" class="input-symbol" data-symbol="，">，</button>
        <button type="button" class="input-symbol" data-symbol="。">。</button>
        <button type="button" class="input-symbol" data-symbol="、">、</button>
        <button type="button" class="input-symbol" data-symbol="！">！</button>
        <button type="button" class="input-symbol" data-symbol="：">：</button>
        <button type="button" class="input-symbol" data-symbol="「">「</button>
        <button type="button" class="input-symbol" data-symbol="」">」</button>
        <button type="button" class="input-symbol" data-symbol="；">；</button>
        <!-- 添加更多按钮 -->
      </div>
      <textarea id="inputField" name="entry.1329760247" placeholder="請在此處輸入" required></textarea>
      <div class="word-count-container">
        <span id="currentWordCount">0</span>/<span id="totalWordCount">0</span> 字數
      </div>
      <!-- 提交按鈕 -->
      <button type="submit">提交練習結果</button>
    </form>
    <!-- 
    <div class="response-container">
      <label>你提交的文字：</label>
      <label id="responseText"></label>
    </div>
    -->
  </div>


  <footer>
    <p>Copyright © SKHTKPSS. All rights reserved. Powered by NKO</p>
  </footer>

  <!-- Bootstrap 5 JS 和 Popper.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 将符号插入到文本输入框的光标位置
    function insertSymbolAtCursor(symbol) {
      const inputField = document.getElementById('inputField');
      // 保存当前的光标位置
      const cursorPosition = inputField.selectionStart;
      // 目前输入框的内容
      const currentValue = inputField.value;
      // 将符号插入到当前光标位置
      const newValue = currentValue.slice(0, cursorPosition) + symbol + currentValue.slice(cursorPosition);
      inputField.value = newValue;
      // 更新光标位置，使其位于插入的符号后
      inputField.selectionStart = cursorPosition + symbol.length;
      inputField.selectionEnd = cursorPosition + symbol.length;
      // 重新聚焦输入框
      inputField.focus();
    }
    function logout() {
      // 清除所有cookie信息
      document.cookie = "email=; Max-Age=-99999999; path=/";
      document.cookie = "username=; Max-Age=-99999999; path=/";
      document.cookie = "isLogin=; Max-Age=-99999999; path=/";
      // 重定向回登录界面
      window.location.href = 'login.html';
    }

    // 辅助函数：从cookie中读取登录用户名
    function getCookie(name) {
      let cookieArray = document.cookie.split(';');
      for (let i = 0; i < cookieArray.length; i++) {
        let cookiePair = cookieArray[i].split('=');
        if (name == cookiePair[0].trim()) {
          return decodeURIComponent(cookiePair[1]);
        }
      }
      return null;
    }

    function getExercise() {
      const urlParams = new URLSearchParams(window.location.search);
      const exerciseId = urlParams.get('id'); // 获取ID

      // 使用fetch API根据ID从远程JSON中获取练习数据
      fetch('https://raw.githubusercontent.com/nkoooooooo/ChineseTyping/main/exercise.json')
        .then(response => response.json())
        .then(data => {
          const exercise = data.find(ex => ex.id === exerciseId);
          displayExercise(exercise.text, exercise.pinyin);
          // 題號
          document.getElementById('qno').value = exercise.id;
          //console.log(document.getElementById('qno').value)
          // 題目名稱
          document.getElementById('qname').value = exercise.title;
          //console.log(document.getElementById('qname').value)
          // 给用户输入按钮添加事件监听器
          document.getElementById('inputButtons').addEventListener('click', () => {
            handleUserInput(exercise.text);
          });
          // 给用户输入框添加事件监听器
          document.getElementById('inputField').addEventListener('input', () => {
            handleUserInput(exercise.text);
          });
          // 總字數
          const totalWordCountElem = document.getElementById('totalWordCount');
          totalWordCountElem.textContent = exercise.text.length;
        })
        .catch(error => {
          console.error('Error loading exercise:', error);
        });
    }


    function displayExercise(text, pinyin) {
      const textContainer = document.getElementById('exerciseText');
      text.split('').forEach((char, index) => {
        const charPinyin = pinyin.split(' ')[index] || '';
        const characterElem = document.createElement('div');
        characterElem.classList.add('character');
        characterElem.innerHTML = `<span>${char}</span><sub>${charPinyin}</sub>`;
        textContainer.appendChild(characterElem);
      });
    }

    function checkLoginStatus() {
      // 檢查用戶是否已登入，未登入的話重定向到登入頁面
      const isLoggedIn = getCookie('isLogin');
      if (isLoggedIn) {
        // 显示用户名
        if (getCookie('username')) {
          document.getElementById('username').textContent = getCookie('username');
        }
      } else {
        window.location.href = 'login.html';
      }
    }

    window.onload = function () {
      checkLoginStatus();
      getExercise();
      getResponseData();
      // 获取表单input，设置初始值（以学校电邮为例）
      document.getElementById('email').value = getCookie('email');
      //console.log(document.getElementById('email').value)
      // 假设存在另一个字段，例如：用户NAME
      document.getElementById('gname').value = getCookie('username');
      //console.log(document.getElementById('gname').value)
    }

    // 用户输入处理函数
    function handleUserInput(exerciseText) {
      const userInput = document.getElementById('inputField').value;
      // characters 是一个包含所有字符的数组(All characters)
      const characters = document.querySelectorAll('#exerciseText .character');
      // /\s/g 是一个正则表达式，它匹配字符串中所有的空白字符。
      // 在这个表达式中： 
      // \s 匹配单个空格字符，包括空格、制表符、换页符、换行符等。 
      // g 标志是 "global"（全局）的缩写，意味着匹配字符串中的所有空白字符，而不是只匹配第一个。
      const userChars = userInput.replace(/\s/g, '').split('');

      // 遍历用户输入的字符，检查是否与练习文本中的字符匹配 characters index start from 0
      userChars.forEach((char, index) => {
        if (index < characters.length) {
          // 如果文本中的字符匹配用户输入的字符，则添加正确样式
          if (exerciseText[index] === char) {
            characters[index].firstChild.classList.add('correct'); // firstChild 是 <span> 元素
            characters[index].firstChild.classList.remove('incorrect');
          } else {
            characters[index].firstChild.classList.remove('correct');
            characters[index].firstChild.classList.add('incorrect');
          }
        }
      });

      // 处理用户输入超出的情况
      for (let i = userChars.length; i < characters.length; i++) {
        // 移除正确和错误的样式
        characters[i].firstChild.classList.remove('correct');
        characters[i].firstChild.classList.remove('incorrect');
      }

      // 如果用户输入少于或等于练习文本长度，则清除最后一个字符的错误样式
      if (userChars.length < characters.length && userChars.length > 0) {
        characters[userChars.length].firstChild.classList.remove('incorrect');
      }

      // 计算正确的字数
      const correctCharacters = document.querySelectorAll('#exerciseText .character .correct').length;
      document.getElementById('qcorrectnum').value = correctCharacters;
      // 计算错误的字数
      const incorrectCharacters = document.querySelectorAll('#exerciseText .character .incorrect').length;
      document.getElementById('qincorrectnum').value = incorrectCharacters;

      // 進度記錄
      if (correctCharacters === characters.length) {
        document.getElementById('qprogress').value = 1;
      } else {
        document.getElementById('qprogress').value = 0;
      }

      // 更新当前字数
      const currentWordCountElem = document.getElementById('currentWordCount');
      currentWordCountElem.textContent = userChars.length;
    }

  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let lastActivityTime = Date.now();
      let tabSwitches = 0;

      const form = document.getElementById('google-form');
      const inputField = document.getElementById('inputField');
      const textSection = document.getElementById('exerciseText');
      //const responseSection = document.getElementById('responseText');

      form.addEventListener('submit', handleSubmit);
      inputField.addEventListener('paste', preventDefaultAction);
      inputField.addEventListener('copy', preventDefaultAction);
      inputField.addEventListener('cut', preventDefaultAction);
      inputField.addEventListener('drop', preventDefaultAction);
      inputField.addEventListener('dragstart', preventDefaultAction);
      inputField.addEventListener('selectstart', preventDefaultAction);
      textSection.addEventListener('selectstart', preventDefaultAction);
      textSection.onmousedown = textSection.onmouseup = preventDefaultAction;
      //responseSection.addEventListener('selectstart', preventDefaultAction);
      //responseSection.onmousedown = responseSection.onmouseup = preventDefaultAction;

      document.onkeydown = checkForProhibitedActions;
      document.oncontextmenu = preventDefaultAction;
      document.addEventListener('mousemove', () => lastActivityTime = Date.now());
      document.addEventListener('keypress', () => lastActivityTime = Date.now());
      window.addEventListener('blur', () => {
        tabSwitches++;
        if (tabSwitches % 5 == 0) {
          alert('請專心打字練習，不要切換到其他視窗！');
        }
      });

      setInterval(() => {
        const currentTime = Date.now();
        if (currentTime - lastActivityTime > (3 * 60 * 1000)) {
          alert('您已經超過3分鐘未進行任何操作。');
        }
      }, 60 * 1000);

      // 监听所有符号按钮的点击事件
      document.querySelectorAll('.input-symbol').forEach(button => {
        button.addEventListener('click', function () {
          insertSymbolAtCursor(this.dataset.symbol);
        });
      });

    });

    function preventDefaultAction(event) {
      event.preventDefault();
    }

    function checkForProhibitedActions(event) {
      const forbiddenKeys = [67, 86, 88, 65, 83, 123];
      const isCtrlPressed = event.ctrlKey;
      const isKeyPressedForbidden = forbiddenKeys.includes(event.keyCode);
      const isRightClick = event.button === 2;
      const isAltPressed = event.altKey;
      const isFKey = event.keyCode >= 112 && event.keyCode <= 123 && event.keyCode !== 116;

      if (isCtrlPressed && isKeyPressedForbidden || isRightClick || isAltPressed || isFKey) {
        event.preventDefault();
      }
    }

    function handleSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);

      fetch(event.target.action, {
        method: 'POST',
        body: formData,
        mode: 'no-cors'
      })
        .then(() => {
          alert('練習提交成功！');
          window.location.href = 'index.html';
        })
        .catch(error => {
          console.error('Error submitting form:', error);
          alert('練習提交出現錯誤');
        });
    }
  </script>
  <script>
    function getResponseData() {
      // 公开的试算表 URL（例如csv格式）
      var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTayq2IE448ev4DhUfeIpzdcKfKERlJ2k28Wou-0faitR5vqIUiYk7bEZ5hBm9nB5MHbEP2i0YmIUi3/pub?gid=365141235&single=true&output=csv';

      fetch(publicSpreadsheetUrl, { cache: "no-cache" })
        .then(response => response.text())
        .then(data => {
          // 将 CSV 数据转换成你可以使用的格式
          var rows = data.split("\n");
          rows.forEach(row => {
            //console.log(row);
            var columns = row.split(",");
            var email = columns[1]; // 电子邮箱
            var questionNumber = columns[3]; // 题号
            // 可以在这里加入条件检查以匹配指定的 email 和题号
            if (email === document.getElementById('email').value && questionNumber === document.getElementById('qno').value) {
              //document.getElementById("responseText").innerHTML = columns[5];
              document.getElementById("inputField").value = columns[5].replace(/\s/g, '');
              
            }
          });
          // 更新当前字数
          const currentWordCountElem = document.getElementById('currentWordCount');
          currentWordCountElem.textContent = document.getElementById("inputField").value.length;
        })
        .catch(error => console.error('Error loading spreadsheet data:', error));
    }

  </script>
</body>

</html>