<!DOCTYPE html>
<html lang="zh-HK">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>打字練習列表 - 中文打字平台</title>
  <!-- 引入Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/fontawesome.min.css">
  <!-- 添加自定义样式 -->
  <style>
    .sticky-top {
      z-index: 1020;
    }

    .table-wrap {
      overflow-x: auto;
    }

    .ftco-section {
      min-height: calc(100vh - 80px - 40px);
    }

    footer {
      width: 100%;
      text-align: center;
      padding: 10px 0;
      font-size: 0.9em;
      background: #f1f1f1;
      color: #888;
    }

    .table-dark th {
      min-width: 48px;
    }

    .table tbody td.status {
      min-width: 90px;

    }

    .table tbody td.status .completed {
      background: #cff6dd;
      color: #1fa750;
      font-size: small;
    }

    .table tbody td.status .completed:after {
      background: #23bd5a;
    }

    .table tbody td.status .waiting {
      background: #fdf5dd;
      color: #cfa00c;
      font-size: small;
    }

    .table tbody td.status .waiting:after {
      background: #f2be1d;
    }

    .table tbody td.status .ongoing {
      background: #c9daff;
      color: #2d63da;
      font-size: small;
    }

    .table tbody td.status .ongoing:after {
      background: #1c55cf;
    }

    .table tbody td.status span {
      position: relative;
      border-radius: 30px;
      padding: 4px 10px 4px 25px;
    }

    .table tbody td.status span:after {
      position: absolute;
      top: 9px;
      left: 10px;
      width: 10px;
      height: 10px;
      content: '';
      border-radius: 50%;
    }
  </style>
</head>

<body>

  <!-- Sticky Navbar 上方的导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">中文打字平台</a>
      <span class="navbar-text ms-auto" id="username">用戶名稱</span>
      <button class="btn btn-outline-warning ms-3" onclick="logout()">登出</button>
    </div>
  </nav>

  <!-- 打型練習列表 -->
  <section class="ftco-section">
    <div class="container">
      <div class="row justify-content-center mb-5">
        <div class="col-md-6 text-center">
          <h2 class="heading-section">打字練習列表</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="table-wrap">
            <table class="table">
              <thead class="table-dark">
                <tr>
                  <th>項目</th>
                  <th>題目</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <!-- 這裡將動態生成打字練習項目 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <p>Copyright © SKHTKPSS. All rights reserved. Powered by NKO</p>
  </footer>

  <!-- Bootstrap 5 JS 和 Popper.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 自定义JavaScript -->
  <script>
    function checkLoginStatus() {
      // 檢查用戶是否已登入，未登入的話重定向到登入頁面
      const isLoggedIn = getCookie('isLogin');
      if (isLoggedIn) {
        // 显示用户名
        if (getCookie('username')) {
          document.getElementById('username').textContent = getCookie('username');
        }
      } else {
        window.location.href = 'login.html';
      }
    }

    window.onload = function () {
      checkLoginStatus();
      getExercises();
      getResponseData();
    }

    // 登出操作
    function logout() {
      // 清除所有cookie信息
      document.cookie = "email=; Max-Age=-99999999; path=/";
      document.cookie = "username=; Max-Age=-99999999; path=/";
      document.cookie = "isLogin=; Max-Age=-99999999; path=/";
      // 重定向回登录界面
      window.location.href = 'login.html';
    }


    // 辅助函数：从cookie中读取登录用户名
    function getCookie(name) {
      let cookieArray = document.cookie.split(';');
      for (let i = 0; i < cookieArray.length; i++) {
        let cookiePair = cookieArray[i].split('=');
        if (name == cookiePair[0].trim()) {
          return decodeURIComponent(cookiePair[1]);
        }
      }
      return null;
    }

    // 聲明一個函數用於更新表格內容
    function updateExerciseTable(exercises) {
      const tableBody = document.querySelector('.table tbody');
      tableBody.innerHTML = ''; // 清空现有内容

      exercises.forEach((exercise) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <th scope="row">${exercise.id}</th>
          <td>${exercise.title}</td>
          <td class="status" data-id="${exercise.id}"><span></span></td>
          <td>
            <a href="#" class="btn btn-primary btn-sm">開始</a>
          </td>
        `;
        tableBody.appendChild(row);
        // 找到开始练习的按钮并添加点击事件
        const startButton = row.querySelector('.btn-primary');
        startButton.setAttribute('href', `exercise.html?id=${exercise.id}`);
      });
    }

    function getExercises() {

      // 使用fetch API從遠端URL加載數據
      fetch('https://raw.githubusercontent.com/nkoooooooo/ChineseTyping/main/exercise.json')
        .then(response => response.json()) // 解析返回的JSON數據
        .then(data => {
          updateExerciseTable(data); // 使用數據更新表格
        })
        .catch(error => {
          // 處理錯誤
          console.error('Fetch error:', error);
        });
    }

    function getResponseData() {
      var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTayq2IE448ev4DhUfeIpzdcKfKERlJ2k28Wou-0faitR5vqIUiYk7bEZ5hBm9nB5MHbEP2i0YmIUi3/pub?gid=365141235&single=true&output=csv';

      fetch(publicSpreadsheetUrl, { cache: "no-cache" })
        .then(response => response.text())
        .then(data => {
          var rows = data.split("\n");
          // 获取所有状态列的 DOM 元素
          var statusElements = document.querySelectorAll('.table tbody .status');

          // 遍历每个状态元素
          statusElements.forEach((statusElement) => {
            //console.log("正在处理:", statusElement);
            var statusId = statusElement.dataset.id;
            //console.log("ELEMENT ID:", statusId);

            // 查找与此状态ID相匹配的CSV记录
            for (var i = rows.length - 1; i > 0; i--) { // 跳过标题行
              var columns = rows[i].split(",");
              var email = columns[1].replace(/\s/g, ''); // 电子邮箱
              var exerciseId = columns[3].replace(/\s/g, ''); // 练习ID
              var csvStatus = columns[8].replace(/\s/g, ''); // 进度状态
              if (email === getCookie('email') && exerciseId === statusId) {
                //console.log("找到匹配记录:", i, email, exerciseId, columns[5], csvStatus);
                //console.log("进度状态:", csvStatus);
                // 根据 CSV 中的状态，更新状态列的显示
                var span = statusElement.querySelector('span');
                span.className = ''; // 先清除所有的类名
                switch (csvStatus) {
                  case '1':
                    span.classList.add('completed');
                    span.textContent = '已完成';
                    break;
                  case '0':
                    span.classList.add('ongoing');
                    span.textContent = '進行中';
                    break;
                  default:
                    span.classList.add('waiting');
                    span.textContent = '未開始';
                }
                break;  // 找到后即停止搜索此 exerciseId 的记录
              }
            }
          });

        })
        .catch(error => console.error('Error loading spreadsheet data:', error));
    }
  </script>
</body>

</html>